version: '3.7'

services:
  # 小红书爬虫服务（生产环境 - 使用远程镜像）
  xhs-crawler:
    # 使用阿里云镜像仓库
    image: your-registry.example.com/your-namespace/xhs-crawler:1.0.0
    
    container_name: xhs-crawler
    restart: unless-stopped
    
    ports:
      - "3000:3000"
    
    environment:
      # 应用配置
      NODE_ENV: production
      PORT: 3000
      
      # 数据库配置
      DATABASE_PATH: /app/data/accounts.db
      TYPEORM_SYNCHRONIZE: "true"  # 首次启动自动创建表，后续可以改为 false
      
      # Puppeteer配置（重要：使用系统 Chromium）
      PUPPETEER_SKIP_DOWNLOAD: "true"
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
      
      # 浏览器连接池配置（低配服务器优化）
      BROWSER_POOL_MIN_SIZE: 1        # 初始浏览器实例数（低配服务器）
      BROWSER_POOL_MAX_SIZE: 3        # 最大浏览器实例数（低配服务器）
      BROWSER_IDLE_TIMEOUT: 1800000   # 浏览器空闲超时（毫秒，30分钟）
    
    volumes:
      # 持久化数据库
      - ./data:/app/data
      # 持久化日志
      - ./logs:/app/logs
    
    # 增加共享内存（Chromium 需要）
    shm_size: '2gb'
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    
    networks:
      - xhs-network
    
    # 资源限制（可选，生产环境建议配置）
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    
    # 日志配置（避免日志占满磁盘）
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  xhs-network:
    driver: bridge
